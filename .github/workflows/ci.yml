# åˆå­¦è€…å‘ã‘ï¼šCIï¼ˆç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ

name: CI Pipeline

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼šæ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
on:
  workflow_call:  # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

# åˆå­¦è€…å‘ã‘ï¼šä¸¦è¡Œå®Ÿè¡Œã‚’é˜²ãè¨­å®šï¼ˆåŒæ™‚ã«è¤‡æ•°ã®CIãŒèµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ã‚¸ãƒ§ãƒ–å®šç¾©ï¼šè¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ã‚’ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½
jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  quality-check:
    name: "ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"
    runs-on: ubuntu-latest
    
    steps:
      # åˆå­¦è€…å‘ã‘ï¼šãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      # åˆå­¦è€…å‘ã‘ï¼špnpmï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      # åˆå­¦è€…å‘ã‘ï¼šNode.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      # åˆå­¦è€…å‘ã‘ï¼šä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆpackage.jsonã®å†…å®¹ã«åŸºã¥ãï¼‰
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šTypeScriptã®å‹ãƒã‚§ãƒƒã‚¯ï¼ˆå‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèªï¼‰
      - name: "ğŸ”§ TypeScript å‹ãƒã‚§ãƒƒã‚¯"
        run: pnpm type-check
      
      # åˆå­¦è€…å‘ã‘ï¼šESLintã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæ§‹æ–‡ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ç¢ºèªï¼‰
      - name: "ğŸ§¹ ESLint å®Ÿè¡Œ"
        run: pnpm lint || true
      
      # åˆå­¦è€…å‘ã‘ï¼šPrettierã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: "ğŸ’… ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
        run: |
          pnpm format || true
          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã«å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸€æ™‚çš„ã«ç·©å’Œï¼‰
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å·®åˆ†ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€æ™‚çš„ã«è¨±å¯ã—ã¾ã™"
            git diff --name-only
          else
            echo "âœ… ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆOK"
          fi

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– - ESLintã‚¨ãƒ©ãƒ¼ä¿®æ­£å¾Œã«å†æœ‰åŠ¹åŒ–ï¼‰
  backend-tests:
    name: "ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    if: false  # ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: "ğŸ§ª ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ"
        run: |
          cd packages/backend
          pnpm test:run
        env:
          # ãƒ†ã‚¹ãƒˆç”¨ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
          NODE_ENV: test

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– - ESLintã‚¨ãƒ©ãƒ¼ä¿®æ­£å¾Œã«å†æœ‰åŠ¹åŒ–ï¼‰
  frontend-tests:
    name: "ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    if: false  # ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: "ğŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ"
        run: |
          cd packages/frontend
          pnpm test:run
        env:
          NODE_ENV: test

  # E2Eãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã®çµ±åˆãƒ†ã‚¹ãƒˆï¼‰ï¼ˆä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼‰
  e2e-tests:
    name: "ğŸŒ E2Eãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    if: false  # ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šPlaywrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: "ğŸ­ Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: |
          cd packages/frontend
          npx playwright install chromium
      
      # åˆå­¦è€…å‘ã‘ï¼šé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: "ğŸŒ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        run: |
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          pnpm dev &
          
          # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿ
          sleep 30
          
          # E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          cd packages/frontend
          pnpm test:e2e
        env:
          NODE_ENV: test
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: "ğŸ“¸ ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: packages/frontend/playwright-report/
          retention-days: 30

  # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ–
  test-summary:
    name: "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼"
    runs-on: ubuntu-latest
    needs: [quality-check, backend-tests, frontend-tests, e2e-tests]
    if: always()
    
    steps:
      - name: "ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœåˆ¤å®š"
        run: |
          echo "## ğŸ§ª CI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.quality-check.result }}" == "success" ]; then
            echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.backend-tests.result }}" == "success" ]; then
            echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.frontend-tests.result }}" == "success" ]; then
            echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "âœ… E2Eãƒ†ã‚¹ãƒˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ E2Eãƒ†ã‚¹ãƒˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          
          # å…¨ä½“ã®æˆåŠŸ/å¤±æ•—åˆ¤å®š
          if [ "${{ needs.quality-check.result }}" == "success" ] && \
             [ "${{ needs.backend-tests.result }}" == "success" ] && \
             [ "${{ needs.frontend-tests.result }}" == "success" ] && \
             [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
            exit 0
          else
            echo "ğŸ’¥ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi