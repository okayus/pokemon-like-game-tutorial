# åˆå­¦è€…å‘ã‘ï¼šãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# mainãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸æ™‚ï¼šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ æˆåŠŸæ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼šãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ

name: Main Pipeline

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼šãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¨mainãƒ–ãƒ©ãƒ³ãƒãƒ—ãƒƒã‚·ãƒ¥æ™‚
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

# åˆå­¦è€…å‘ã‘ï¼šä¸¦è¡Œå®Ÿè¡Œã‚’é˜²ãè¨­å®š
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  # ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆæ—¢å­˜ã®CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨åŒã˜ï¼‰
  run-tests:
    name: "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
    uses: ./.github/workflows/ci.yml

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã§ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã®ã¿ï¼‰
  deploy:
    name: "ğŸš€ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤"
    needs: run-tests
    if: github.ref == 'refs/heads/main' && needs.run-tests.result == 'success'
    uses: ./.github/workflows/deploy.yml
    secrets: inherit

  # çµæœã‚µãƒãƒªãƒ¼
  pipeline-summary:
    name: "ğŸ“Š ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµæœ"
    runs-on: ubuntu-latest
    needs: [run-tests, deploy]
    if: always()
    
    steps:
      - name: "ğŸ“‹ å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼"
        run: |
          echo "## ğŸ”„ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œè€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ†ã‚¹ãƒˆçµæœ
          if [ "${{ needs.run-tests.result }}" == "success" ]; then
            echo "âœ… **ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿ï¼‰
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            if [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
              echo "â­ï¸ **ãƒ‡ãƒ—ãƒ­ã‚¤**: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—ã®ãŸã‚ï¼‰" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **ãƒ‡ãƒ—ãƒ­ã‚¤**: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # çµæœåˆ¤å®š
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            if [ "${{ needs.run-tests.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "ğŸ‰ **ç·åˆçµæœ**: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã‚‚ã«æˆåŠŸï¼"
              exit 0
            else
              echo "ğŸ’¥ **ç·åˆçµæœ**: ãƒ†ã‚¹ãƒˆã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
            fi
          else
            if [ "${{ needs.run-tests.result }}" == "success" ]; then
              echo "âœ… **ç·åˆçµæœ**: ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰"
              exit 0
            else
              echo "âŒ **ç·åˆçµæœ**: ãƒ†ã‚¹ãƒˆå¤±æ•—"
              exit 1
            fi
          fi