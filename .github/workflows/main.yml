# åˆå­¦è€…å‘ã‘ï¼šãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# mainãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸æ™‚ï¼šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ æˆåŠŸæ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼šãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ

name: Main Pipeline

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼šãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¨mainãƒ–ãƒ©ãƒ³ãƒãƒ—ãƒƒã‚·ãƒ¥æ™‚
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

# åˆå­¦è€…å‘ã‘ï¼šä¸¦è¡Œå®Ÿè¡Œã‚’é˜²ãè¨­å®š
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ã‚¸ãƒ§ãƒ–å®šç¾©ï¼šå€‹åˆ¥ã®ã‚¸ãƒ§ãƒ–ã‚’ç›´æ¥å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  quality-check:
    name: "ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"
    runs-on: ubuntu-latest
    
    steps:
      # åˆå­¦è€…å‘ã‘ï¼šãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      # åˆå­¦è€…å‘ã‘ï¼špnpmï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      # åˆå­¦è€…å‘ã‘ï¼šNode.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      # åˆå­¦è€…å‘ã‘ï¼šä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆpackage.jsonã®å†…å®¹ã«åŸºã¥ãï¼‰
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šTypeScriptã®å‹ãƒã‚§ãƒƒã‚¯ï¼ˆå‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèªï¼‰
      - name: "ğŸ”§ TypeScript å‹ãƒã‚§ãƒƒã‚¯"
        run: pnpm type-check
      
      # åˆå­¦è€…å‘ã‘ï¼šESLintã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæ§‹æ–‡ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ç¢ºèªï¼‰
      - name: "ğŸ§¹ ESLint å®Ÿè¡Œ"
        run: pnpm lint
      
      # åˆå­¦è€…å‘ã‘ï¼šPrettierã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: "ğŸ’… ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
        run: |
          pnpm format
          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã«å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å·®åˆ†ãŒã‚ã‚Šã¾ã™"
            git diff --name-only
            exit 1
          else
            echo "âœ… ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆOK"
          fi

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  backend-tests:
    name: "ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    needs: quality-check  # å“è³ªãƒã‚§ãƒƒã‚¯å¾Œã«å®Ÿè¡Œ
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: "ğŸ§ª ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ"
        run: |
          cd packages/backend
          pnpm test:run
        env:
          # ãƒ†ã‚¹ãƒˆç”¨ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
          NODE_ENV: test

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  frontend-tests:
    name: "ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    needs: quality-check  # å“è³ªãƒã‚§ãƒƒã‚¯å¾Œã«å®Ÿè¡Œ
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: "ğŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ"
        run: |
          cd packages/frontend
          pnpm test:run
        env:
          NODE_ENV: test

  # E2Eãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã®çµ±åˆãƒ†ã‚¹ãƒˆï¼‰
  e2e-tests:
    name: "ğŸŒ E2Eãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]  # å˜ä½“ãƒ†ã‚¹ãƒˆå¾Œã«å®Ÿè¡Œ
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šPlaywrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: "ğŸ­ Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: |
          cd packages/frontend
          npx playwright install chromium
      
      # åˆå­¦è€…å‘ã‘ï¼šé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: "ğŸŒ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        run: |
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          pnpm dev &
          
          # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿ
          sleep 30
          
          # E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          cd packages/frontend
          pnpm test:e2e
        env:
          NODE_ENV: test
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: "ğŸ“¸ ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: packages/frontend/playwright-report/
          retention-days: 30

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã§ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã®ã¿ï¼‰
  deploy:
    name: "ğŸš€ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤"
    needs: [quality-check, backend-tests, frontend-tests, e2e-tests]
    if: github.ref == 'refs/heads/main' && needs.quality-check.result == 'success' && needs.backend-tests.result == 'success' && needs.frontend-tests.result == 'success' && needs.e2e-tests.result == 'success'
    uses: ./.github/workflows/deploy.yml
    secrets: inherit

  # çµæœã‚µãƒãƒªãƒ¼
  pipeline-summary:
    name: "ğŸ“Š ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµæœ"
    runs-on: ubuntu-latest
    needs: [quality-check, backend-tests, frontend-tests, e2e-tests, deploy]
    if: always()
    
    steps:
      - name: "ğŸ“‹ å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼"
        run: |
          echo "## ğŸ”„ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œè€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.quality-check.result }}" == "success" ]; then
            echo "âœ… **ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.backend-tests.result }}" == "success" ]; then
            echo "âœ… **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.backend-tests.result }}" == "skipped" ]; then
            echo "â­ï¸ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸€æ™‚ç„¡åŠ¹åŒ–ä¸­ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.frontend-tests.result }}" == "success" ]; then
            echo "âœ… **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.frontend-tests.result }}" == "skipped" ]; then
            echo "â­ï¸ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸€æ™‚ç„¡åŠ¹åŒ–ä¸­ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "âœ… **E2Eãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.e2e-tests.result }}" == "skipped" ]; then
            echo "â­ï¸ **E2Eãƒ†ã‚¹ãƒˆ**: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸€æ™‚ç„¡åŠ¹åŒ–ä¸­ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **E2Eãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            if [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
              echo "â­ï¸ **ãƒ‡ãƒ—ãƒ­ã‚¤**: ã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          
          # çµæœåˆ¤å®šï¼ˆå…¨ãƒ†ã‚¹ãƒˆæœ‰åŠ¹åŒ–ï¼‰
          if [ "${{ needs.quality-check.result }}" == "success" ] && \
             [ "${{ needs.backend-tests.result }}" == "success" ] && \
             [ "${{ needs.frontend-tests.result }}" == "success" ] && \
             [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
            exit 0
          else
            echo "ğŸ’¥ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi