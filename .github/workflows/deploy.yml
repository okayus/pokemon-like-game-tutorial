# åˆå­¦è€…å‘ã‘ï¼šCDï¼ˆç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸéš›ã«è‡ªå‹•ã§Cloudflareã«ãƒ‡ãƒ—ãƒ­ã‚¤

name: Deploy to Cloudflare

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼šæ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
on:
  workflow_dispatch:  # ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  workflow_call:      # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ã«ã™ã‚‹

# åˆå­¦è€…å‘ã‘ï¼šãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¸¦è¡Œå®Ÿè¡Œã‚’é˜²ãï¼ˆåŒæ™‚ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã®ç«¶åˆã‚’é¿ã‘ã‚‹ï¼‰
concurrency:
  group: deploy-production
  cancel-in-progress: false

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  # ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã‚¸ãƒ§ãƒ–
  prepare-deploy:
    name: "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™"
    runs-on: ubuntu-latest
    
    # åˆå­¦è€…å‘ã‘ï¼šç’°å¢ƒå¤‰æ•°ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆå®šç¾©
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      commit-message: ${{ steps.check.outputs.commit-message }}
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å‰å›ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®æ¯”è¼ƒã®ãŸã‚
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒ‡ãƒ—ãƒ­ã‚¤ã™ã¹ãã‹ã®åˆ¤å®š
      - name: "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¡ä»¶ãƒã‚§ãƒƒã‚¯"
        id: check
        run: |
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "commit-message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$COMMIT_MESSAGE" | grep -E "(skip deploy|no deploy)" > /dev/null; then
            echo "â­ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¹ã‚­ãƒƒãƒ—æŒ‡ç¤ºã‚ã‚Šï¼‰"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    name: "ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰"
    runs-on: ubuntu-latest
    needs: prepare-deploy
    if: needs.prepare-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      # åˆå­¦è€…å‘ã‘ï¼šãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç”¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      - name: "ğŸ”¨ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰"
        run: pnpm build
        env:
          NODE_ENV: production

  # Cloudflare Pages ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
  deploy-frontend:
    name: "ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ‡ãƒ—ãƒ­ã‚¤"
    runs-on: ubuntu-latest
    needs: [prepare-deploy, build]
    if: needs.prepare-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      - name: "ğŸ”¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰"
        run: pnpm build
        working-directory: packages/frontend
        env:
          NODE_ENV: production
      
      # åˆå­¦è€…å‘ã‘ï¼šCloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
      - name: "â˜ï¸ Pages ãƒ‡ãƒ—ãƒ­ã‚¤"
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: pokemon-like-game
          directory: packages/frontend/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # Cloudflare Workers ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIï¼‰
  deploy-backend:
    name: "ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ‡ãƒ—ãƒ­ã‚¤"
    runs-on: ubuntu-latest
    needs: [prepare-deploy, build]
    if: needs.prepare-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: "ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "ğŸ—ï¸ pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: pnpm/action-setup@v2
        with:
          version: "10.12.1"
      
      - name: "âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      
      - name: "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: pnpm install --frozen-lockfile
      
      - name: "ğŸ”¨ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰"
        run: pnpm build
        working-directory: packages/backend
        env:
          NODE_ENV: production
      
      # åˆå­¦è€…å‘ã‘ï¼šCloudflare Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
      - name: "â˜ï¸ Workers ãƒ‡ãƒ—ãƒ­ã‚¤"
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/backend

  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥ã‚¸ãƒ§ãƒ–
  deploy-complete:
    name: "ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥"
    runs-on: ubuntu-latest
    needs: [prepare-deploy, deploy-frontend, deploy-backend]
    if: always() && needs.prepare-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚µãƒãƒªãƒ¼"
        run: |
          echo "## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ needs.prepare-deploy.outputs.commit-message }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆPagesï¼‰: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆPagesï¼‰: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆWorkersï¼‰: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆWorkersï¼‰: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é‡è¦**: Cloudflareèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "è¨­å®šæ–¹æ³•ã«ã¤ã„ã¦ã¯ \`docs/cicd-implementation-plan.md\` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          
          # çµæœåˆ¤å®š
          if [ "${{ needs.deploy-frontend.result }}" == "success" ] && \
             [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸï¼"
          else
            echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†ï¼ˆä¸€éƒ¨ã‚¹ã‚­ãƒƒãƒ—ã¾ãŸã¯å¤±æ•—ï¼‰"
          fi